<!DOCTYPE html>
<html lang="en">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>Diabetes Risk Assessment AI</title>
    
    <!-- TensorFlow.js -->
    <script src="https://cdn.jsdelivr.net/npm/@tensorflow/tfjs@latest/dist/tf.min.js"></script>
    
    <!-- Tailwind CSS for styling -->
    <script src="https://cdn.tailwindcss.com"></script>
    
    <!-- Inter Font -->
    <link href="https://fonts.googleapis.com/css2?family=Inter:wght@300;400;600;700&display=swap" rel="stylesheet">
    
    <style>
        body { font-family: 'Inter', sans-serif; }
        /* Smooth fade in for results */
        .fade-in { animation: fadeIn 0.5s ease-in; }
        @keyframes fadeIn { from { opacity: 0; transform: translateY(10px); } to { opacity: 1; transform: translateY(0); } }
    </style>
</head>
<body class="bg-slate-50 text-slate-800 min-h-screen flex flex-col items-center py-10 px-4">

    <!-- Main Card -->
    <div class="w-full max-w-2xl bg-white rounded-2xl shadow-xl overflow-hidden border border-slate-100">
        
        <!-- Header -->
        <div class="bg-blue-600 p-6 text-white text-center">
            <h1 class="text-3xl font-bold mb-2">Health Risk AI</h1>
            <p class="text-blue-100 text-sm">Powered by Neural Networks & TensorFlow.js</p>
        </div>

        <!-- Model Status Indicator -->
        <div id="model-status" class="bg-yellow-50 text-yellow-700 px-6 py-2 text-xs font-semibold text-center border-b border-yellow-100">
            ⏳ Loading Neural Network Model...
        </div>

        <!-- DEBUG ERROR BOX (Only shows on error) -->
        <div id="error-box" class="hidden bg-red-100 border-l-4 border-red-500 text-red-700 p-4 m-4 text-sm font-mono whitespace-pre-wrap"></div>

        <div class="p-8">
            <p class="text-slate-500 mb-6 text-center">
                Enter the patient's biomarker data below to calculate the statistical risk factor.
            </p>

            <!-- Input Grid -->
            <div class="grid grid-cols-1 md:grid-cols-2 gap-6 mb-8">
                
                <!-- Input 1: Glucose -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">
                        Fasting Glucose
                        <span class="text-xs font-normal text-slate-400 ml-1">(mg/dL)</span>
                    </label>
                    <input type="number" id="glucose" placeholder="e.g. 90" 
                        class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all placeholder-slate-400">
                </div>

                <!-- Input 2: Insulin -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">
                        Insulin
                        <span class="text-xs font-normal text-slate-400 ml-1">(uU/mL)</span>
                    </label>
                    <input type="number" id="insulin" placeholder="e.g. 6" 
                        class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all placeholder-slate-400">
                </div>

                <!-- Input 3: Glycohemoglobin -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">
                        Glycohemoglobin (A1C)
                        <span class="text-xs font-normal text-slate-400 ml-1">(%)</span>
                    </label>
                    <input type="number" id="a1c" placeholder="e.g. 5.2" 
                        class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all placeholder-slate-400">
                </div>

                <!-- Input 4: Albumin -->
                <div>
                    <label class="block text-sm font-bold text-slate-700 mb-2">
                        Albumin (Urine)
                        <span class="text-xs font-normal text-slate-400 ml-1">(ug/mL)</span>
                    </label>
                    <input type="number" id="albumin" placeholder="e.g. 5" 
                        class="w-full px-4 py-3 rounded-lg bg-slate-50 border border-slate-300 focus:border-blue-500 focus:ring-2 focus:ring-blue-200 outline-none transition-all placeholder-slate-400">
                </div>
            </div>

            <!-- Action Button -->
            <button id="predict-btn" onclick="runPrediction()" disabled 
                class="w-full bg-slate-300 text-slate-500 font-bold py-4 rounded-xl shadow-lg transition-all transform active:scale-95 cursor-not-allowed">
                Wait, Loading Model...
            </button>

        </div>

        <!-- Result Area (Hidden by default) -->
        <div id="result-card" class="hidden border-t border-slate-100">
            <div class="p-8 text-center bg-slate-50">
                <h3 class="text-sm font-bold text-slate-400 uppercase tracking-wide mb-2">Prediction Result</h3>
                
                <div id="risk-badge" class="inline-block px-6 py-2 rounded-full text-lg font-bold mb-4 shadow-sm">
                    <!-- JS will fill this -->
                </div>
                
                <p id="probability-text" class="text-slate-600">
                    <!-- JS will fill this -->
                </p>

                <!-- Disclaimer -->
                <p class="text-xs text-slate-400 mt-6 max-w-xs mx-auto">
                    *This is an AI demonstration model. Do not use for actual medical diagnosis.
                </p>
            </div>
        </div>
    </div>

    <script>
        // ==========================================
        //  CONFIGURATION
        // ==========================================
        
        // TODO: PASTE YOUR VALUES FROM COLAB HERE!
        // These MUST match the order: [Glucose, Insulin, A1C, Albumin]
        const MEAN = [108.64664586583463, 14.103623244929798, 5.722542901716069, 34.87434087363494];  
        const SCALE = [33.80837449653085, 23.280870538082155, 1.02893342159197, 158.8108890029497]; 

        // ==========================================
        //  LOGIC
        // ==========================================
        
        let model;
        const statusEl = document.getElementById('model-status');
        const btn = document.getElementById('predict-btn');
        const errorBox = document.getElementById('error-box');

        // Helper to show errors on screen
        function showError(msg, details) {
            statusEl.innerHTML = "❌ Error Loading Model";
            statusEl.className = "bg-red-50 text-red-700 px-6 py-2 text-xs font-semibold text-center border-b border-red-100";
            errorBox.classList.remove('hidden');
            errorBox.innerText = `${msg}\n\nTechnical Details:\n${details}`;
        }

        // 1. Smart Model Loader (Auto-Fixes InputShape Issues)
        async function loadModel() {
            try {
                const modelPath = './web_model/model.json';
                
                // Get the directory where index.html is running
                // FIX: Remove index.html from path if present to get true base directory
                const baseURL = window.location.href.substring(0, window.location.href.lastIndexOf('/') + 1);
                const weightsBaseURL = baseURL + 'web_model/';

                console.log("Fetching model.json manually to inspect...");
                
                // Fetch the JSON file text first
                const response = await fetch(modelPath);
                if (!response.ok) throw new Error(`Failed to fetch model.json (Status ${response.status})`);
                const jsonText = await response.text();
                const modelJson = JSON.parse(jsonText);

                console.log("Model JSON parsed. Checking configuration...");

                // --- HOTFIX START: Manually inject Input Shape if missing ---
                // The error "InputLayer should be passed either a batchInputShape or an inputShape" 
                // happens when Keras export misses the input config. We fix it here.
                
                // Navigate to the first layer's config
                const config = modelJson?.modelTopology?.model_config?.config;
                if (config && config.layers && config.layers.length > 0) {
                    const firstLayer = config.layers[0];
                    
                    // Check if batch_input_shape is missing
                    if (!firstLayer.config.batch_input_shape && !firstLayer.config.input_shape) {
                        console.warn("⚠️ Missing input shape detected. Patching model.json...");
                        // We know we have 4 inputs (Glucose, Insulin, A1C, Albumin)
                        firstLayer.config.batch_input_shape = [null, 4]; 
                    }
                }
                // --- HOTFIX END ---

                // --- PATH FIX START: Ensure weights are found ---
                // Since we are loading from a blob, relative paths might break.
                // We convert the weights filename to a full URL.
                if (modelJson.weightsManifest) {
                    modelJson.weightsManifest.forEach(manifest => {
                        manifest.paths = manifest.paths.map(path => {
                            // If it's just a filename, assume it's in the same folder as model.json
                            if (!path.includes('http') && !path.includes('/')) {
                                return weightsBaseURL + path;
                            }
                            return path;
                        });
                    });
                }
                // --- PATH FIX END ---

                // Convert our modified JSON object back to a file (Blob) that TFJS can read
                const blob = new Blob([JSON.stringify(modelJson)], { type: 'application/json' });
                const url = URL.createObjectURL(blob);

                // Load the model from our patched file
                model = await tf.loadLayersModel(url);
                
                // Clean up the blob URL
                URL.revokeObjectURL(url);

                // Update UI to show ready
                statusEl.innerHTML = "✅ AI Model Loaded & Ready";
                statusEl.className = "bg-green-50 text-green-700 px-6 py-2 text-xs font-semibold text-center border-b border-green-100";
                
                btn.disabled = false;
                btn.innerText = "Run Analysis";
                btn.className = "w-full bg-blue-600 hover:bg-blue-700 text-white font-bold py-4 rounded-xl shadow-lg hover:shadow-blue-500/30 transition-all transform hover:-translate-y-1 active:scale-95";
                
                console.log("Model loaded successfully via SmartLoader");

            } catch (e) {
                console.error("Model load error:", e);
                showError("Error loading or patching the model file.", e.message);
            }
        }
        
        loadModel();

        // 2. Prediction Function
        async function runPrediction() {
            // Get inputs
            const g = parseFloat(document.getElementById('glucose').value);
            const i = parseFloat(document.getElementById('insulin').value);
            const a1 = parseFloat(document.getElementById('a1c').value);
            const al = parseFloat(document.getElementById('albumin').value);

            // Validation
            if (isNaN(g) || isNaN(i) || isNaN(a1) || isNaN(al)) {
                alert("Please fill in all biomarker fields with valid numbers.");
                return;
            }

            // Manual Scaling (StandardScaler logic: (x - u) / s)
            // Order must match Python: Glucose, Insulin, A1C, Albumin
            const inputs = [g, i, a1, al];
            const scaledInputs = inputs.map((val, idx) => (val - MEAN[idx]) / SCALE[idx]);

            // Create Tensor
            const tensor = tf.tensor2d([scaledInputs]);

            // Predict
            const prediction = model.predict(tensor);
            const data = await prediction.data();
            const probability = data[0]; // Value between 0 and 1

            // Update UI
            displayResult(probability);
        }

        // 3. UI Update Helper
        function displayResult(prob) {
            const resultCard = document.getElementById('result-card');
            const riskBadge = document.getElementById('risk-badge');
            const probText = document.getElementById('probability-text');
            
            resultCard.classList.remove('hidden');
            resultCard.classList.add('fade-in');

            const percentage = (prob * 100).toFixed(1);

            if (prob > 0.5) {
                // High Risk Styles
                riskBadge.innerText = "High Risk Detected";
                riskBadge.className = "inline-block px-6 py-2 rounded-full text-lg font-bold mb-4 shadow-sm bg-red-100 text-red-600 border border-red-200";
                probText.innerHTML = `The model predicts a <span class="font-bold text-red-600">${percentage}%</span> probability of diabetes risk based on these biomarkers.`;
            } else {
                // Low Risk Styles
                riskBadge.innerText = "Low Risk Profile";
                riskBadge.className = "inline-block px-6 py-2 rounded-full text-lg font-bold mb-4 shadow-sm bg-green-100 text-green-600 border border-green-200";
                probText.innerHTML = `The model predicts a <span class="font-bold text-green-600">${percentage}%</span> probability, which is within the lower risk range.`;
            }

            // Scroll to result
            resultCard.scrollIntoView({ behavior: 'smooth' });
        }
    </script>
</body>
</html>